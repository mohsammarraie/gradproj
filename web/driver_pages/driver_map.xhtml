<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:p="http://primefaces.org/ui"
      xmlns:c="http://xmlns.jcp.org/jsp/jstl/core">
    <h:head>
        <title>#{msgs.app_title}</title>
    </h:head>
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?key=AIzaSyAT-PnUumnLEeph1uswtj11VoLEjdeO_90"></script>
    <script type="text/javascript" src="http://www.google.com/jsapi"></script>
    <h:body> 
        <ui:decorate template="/app_templates/app_template.xhtml">   
     
                <h:form id="driver_trip_info_form">
                    <p:dataTable 
                           id="driver_trip_info_tbl"
                           value = "#{tripsBean.driverRouteSchedulesStopsArray}"
                           class = "dataTable"
                           var="driverRouteScheduleStop"
                           rows="5"
                           rowsPerPageTemplate="5,10,20"
                           dir="#{langBean.dir}"
                           emptyMessage="#{msgs.no_schedules}"
                           >


                        <f:facet name="header" id="header">
                            #{msgs.route_stops}
                        </f:facet> 
                        <c:forEach var="stop" items="#{tripsBean.driverRouteSchedulesStopsArray}">
                            <p:column headerText="#{langBean.isEnglish?stop.stopNameEn:stop.stopNameAr}"
                                      style="width:20%">
                                <h:form rendered="#{driverRouteScheduleStop.stopId==stop.stopId}">

                                    <h:outputText value="#{driverRouteScheduleStop.time}">  
                                        <f:convertDateTime pattern="HH:mm" />
                                    </h:outputText>
                                </h:form>   
                            </p:column>
                        </c:forEach>
                    </p:dataTable>
                    <p:commandButton value="#{msgs.cancel}"
                                     icon="ui-icon-pencil"
                                     iconPos="#{langBean.styleFloat}"
                                     styleClass="commandButton"
                                     style="float:#{langBean.styleFloat}"  
                                     ajax ="false"
                                     onclick="return confirm('#{msgs.confirm_cancel_trip}');"
                                     actionListener="#{tripsBean.cancelTrip()}" />
                     <p:commandButton value="#{msgs.end_trip}"
                                     icon="ui-icon-pencil"
                                     iconPos="#{langBean.styleFloat}"
                                     styleClass="commandButton"
                                     style="float:#{langBean.styleFloat}"  
                                     ajax ="false"
                                     onclick="return confirm('#{msgs.confirm_end_trip}');"
                                     actionListener="#{tripsBean.endTrip()}" />
                </h:form>

                <p:gmap id="gmap2" widgetVar="w_gmap" type="roadmap" center="0, 0" zoom="16" style="width:600px;height:400px" />       
                <h:form>
                    <p:poll interval="5" oncomplete="checkGeolocationByHTML5()" update="gmap2"/>
                    <p:remoteCommand name="myRemoteCommand" process="@this" autoRun="false" actionListener="#{driverMapBean.saveCoordinates()}"/>
                </h:form> 
        
            <script type="text/javascript">
                if (navigator.geolocation) {
                    checkGeolocationByHTML5();
                } else {
                    checkGeolocationByLoaderAPI(); // HTML5 not supported go back to Loader API.
                }

                function checkGeolocationByHTML5() {
                    navigator.geolocation.getCurrentPosition(function(position) {
                        setMapCenter(position.coords.latitude, position.coords.longitude);
                    }, function() {
                        checkGeolocationByLoaderAPI(); // Error go back to Loader API.
                    });
                }

                function checkGeolocationByLoaderAPI() {
                    if (google.loader.ClientLocation) {
                        setMapCenter(google.loader.ClientLocation.latitude, google.loader.ClientLocation.longitude);
                    } else {
                        alert("Unsupported");
                    }
                }

                function setMapCenter(latitude, longitude) {
                   PF('w_gmap').getMap().setCenter(new google.maps.LatLng(latitude, longitude));
                   currentMarker = new google.maps.Marker({
                   position:new google.maps.LatLng(latitude, longitude)
            });
                   PF('w_gmap').addOverlay(currentMarker);
                   
                   myRemoteCommand ([{name:'lat',   value: latitude}, {name:'lng',     value: longitude}]);

                }
               

            </script>

            
     

        </ui:decorate>
    </h:body>
</html>
