<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:p="http://primefaces.org/ui"
      xmlns:c="http://xmlns.jcp.org/jsp/jstl/core">
    <h:head>
        <title>#{msgs.trip_map}</title>
<!--        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>-->

    </h:head>
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?key=AIzaSyAT-PnUumnLEeph1uswtj11VoLEjdeO_90"></script>
<!--    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>-->
<!--        <script src="https://maps.googleapis.com/maps/api/js?sensor=true"></script> mobile sensor based-->

    <script type="text/javascript" src="http://www.google.com/jsapi"></script>
    
    <h:body> 
        <ui:decorate template="/app_templates/app_template.xhtml">   

            <h:form id="driver_trip_info_form">


                <p:fieldset legend="#{msgs.route_stops}" style="margin-bottom:20px">
                    <h:panelGrid columns="2" cellpadding="5">

                        <c:forEach var="driverRouteScheduleStop" items="#{tripsBean.driverRouteSchedulesStopsArray}" varStatus="loop">

                            <p:outputLabel value="#{langBean.isEnglish?driverRouteScheduleStop.stopNameEn:driverRouteScheduleStop.stopNameAr}:" for="driver_stop_time_#{loop.index}"/>
                            <h:outputText id="driver_stop_time_#{loop.index}" value="#{driverRouteScheduleStop.time}">  
                                <f:convertDateTime pattern="HH:mm" />
                            </h:outputText>                    
                        </c:forEach>
                    </h:panelGrid>
                </p:fieldset>


            </h:form>

            <p:gmap id="gmap2" widgetVar="w_gmap" type="roadmap" center="0, 0" zoom="16" style="width:600px;height:400px" />    

            <h:form>
                <p:poll interval="5" oncomplete="checkGeolocationByHTML5()" update="gmap2"/>
                <p:remoteCommand name="myRemoteCommand" process="@this" autoRun="false" actionListener="#{driverMapBean.saveCoordinates()}"/>
                
                <p:commandButton value="#{msgs.cancel}"
                                 icon="ui-icon-pencil"
                                 iconPos="#{langBean.styleFloat}"
                                 styleClass="commandButton"
                                 style="float:#{langBean.styleFloat}"  
                                 ajax ="false"
                                 onclick="return confirm('#{msgs.confirm_cancel_trip}');"
                                 actionListener="#{tripsBean.cancelTrip()}" />
                <p:commandButton value="#{msgs.end_trip}"
                                 icon="ui-icon-pencil"
                                 iconPos="#{langBean.styleFloat}"
                                 styleClass="commandButton"
                                 style="float:#{langBean.styleFloat}"  
                                 ajax ="false"
                                 onclick="return confirm('#{msgs.confirm_end_trip}');"
                                 actionListener="#{tripsBean.endTrip()}" />

               

<!--                <p:confirmDialog closeOnEscape="" severity="alert" widgetVar="confirmation" global="true" showEffect="fade" hideEffect="fade" message="Are you sure?">
                    <p:commandButton value="Yes" type="button" styleClass="ui-confirmdialog-yes" icon="ui-icon-check" />
                    <p:commandButton value="No" type="button" styleClass="ui-confirmdialog-no" icon="ui-icon-close" />
                </p:confirmDialog>-->
                
            </h:form> 

            <script type="text/javascript">
                if (navigator.geolocation) {
                    checkGeolocationByHTML5();
                } else {
                    checkGeolocationByLoaderAPI(); // HTML5 not supported go back to Loader API.
                }

                function checkGeolocationByHTML5() {
                    navigator.geolocation.getCurrentPosition(function (position) {
                        setMapCenter(position.coords.latitude, position.coords.longitude);
                    }, function () {
                        checkGeolocationByLoaderAPI(); // Error go back to Loader API.
                    });
                }

                function checkGeolocationByLoaderAPI() {
                    if (google.loader.ClientLocation) {
                        setMapCenter(google.loader.ClientLocation.latitude, google.loader.ClientLocation.longitude);
                    } else {
                        alert("Unsupported");
                    }
                }

                function setMapCenter(latitude, longitude) {
                    PF('w_gmap').getMap().setCenter(new google.maps.LatLng(latitude, longitude));
                    currentMarker = new google.maps.Marker({
                        position: new google.maps.LatLng(latitude, longitude)
                    });
                    PF('w_gmap').addOverlay(currentMarker);

                    myRemoteCommand([{name: 'lat', value: latitude}, {name: 'lng', value: longitude}]);

                }
//                function onBeforeUnload_Handler(){
//                   return PF('confirmation').show(); // confirmation is the "widgetVar" value of p:confirmDialog
//               } 
//
//               window.onbeforeunload = onBeforeUnload_Handler;
//               
//               $(window).bind('beforeunload', function(){
//                         PF('confirmation').show();
//                        return"das";
//                });

            </script>
   




        </ui:decorate>
    </h:body>
</html>
